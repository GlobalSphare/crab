"use strict";(self.webpackChunkisland_install_front=self.webpackChunkisland_install_front||[]).push([[513],{2225:(e,n,t)=>{t.d(n,{Z:()=>p});var a=t(8390),c=t(7294),l=t(8623),i=t(4313),r=t(9525),s=t(6856),o=t(282);const p=function(e){var n=(0,c.useState)(!1),t=(0,a.Z)(n,2),p=t[0],d=t[1],m=(0,c.useState)([]),u=(0,a.Z)(m,2),f=u[0],v=u[1],y=(0,c.useState)(),h=(0,a.Z)(y,2),g=h[0],E=h[1];(0,c.useEffect)((function(){x(e.data)}),[e.data]);var b,N,k,Z,x=function(e){if(e&&e.dependencies&&(Object.keys(e.dependencies).forEach((function(n){var t=[];e.dependencies[n].instances.forEach((function(a,c){0==c&&"mutable"===e.dependencies[n].type?t.push({instance:a,selected:!0}):t.push({instance:a,selected:!1})})),e.dependencies[n].instances&&e.dependencies[n].instances.length&&"immutable"!==e.dependencies[n].type?e.dependencies[n].location={location:e.dependencies[n].location,selected:!1}:e.dependencies[n].location={location:e.dependencies[n].location,selected:!0},e.dependencies[n].instances=t})),console.log("data===",e),E(e),e.userconfigs&&Object.keys(e.userconfigs).length)){var n=[];!function e(t,a,c,l){t&&("object"==t.type&&t.properties?("userconfigs"!==a&&n.push({key:a,type:t.type,val:"",required:!1,error:"",level:l}),l+=1,Object.keys(t.properties).forEach((function(n){e(t.properties[n],n,t.required,l)}))):n.push({key:a,type:t.type,val:"",required:!!c&&-1!==c.indexOf(a),error:"",level:l}))}(e.userconfigs,"userconfigs",!1,-1),d(!0),v(n)}};function S(){e.close()}function j(e,n,t){if("immutable"!==g.dependencies[n].type||"instance"!=e){var a=Object.assign({},g);"instance"===e?(a.dependencies[n].location.selected=!1,a.dependencies[n].instances.forEach((function(e,n){n==t?(e.selected=!e.selected,e.selected):e.selected=!1}))):"location"===e&&(a.dependencies[n].instances.forEach((function(e,n){e.selected=!1})),a.dependencies[n].location.selected=!a.dependencies[n].location.selected,a.dependencies[n].location.selected),E(a)}}function C(){var e=event.target.dataset.key,n=Object.assign({},g);n.dependencies[e].location.location=event.target.value,E(n)}function w(){var e=event.target.dataset.index,n=f.slice();n[e].val=event.target.value,n[e].error="",v(n)}return c.createElement(l.Z,{open:e.open,onClose:S,"aria-labelledby":"upload-file-title"},c.createElement(i.Z,{id:"upload-file-title"},e.title),c.createElement(r.Z,null,c.createElement("div",{className:"instance-content"},(b=e.data,k=[],Z=-34,(N=b.dependencies||null)&&(Z+=34,Object.keys(N).forEach((function(e,n){k.push(c.createElement("div",{style:{paddingLeft:Z+"px"},className:"app-item",key:n},c.createElement("div",{className:"app-label"},c.createElement("span",{style:{backgroundColor:"#54CACB"},className:"label-icon app-icon"},c.createElement("i",{className:"iconfont icon_grey600"})," "),c.createElement("span",{className:"label-name"},e)),(N[e].instances||[]).map((function(n,t){return c.createElement("div",{key:t,className:"app-item-versions"},c.createElement("div",{className:"app-label",key:t},c.createElement("span",{className:"label-icon version-icon",onClick:function(){j("instance",e,t)}},c.createElement("i",{style:{color:"mutable"===N[e].type?"#54CACB":"#e0e0e0"},className:"".concat(n.selected?"iconfont icon_d-pass":"")})),c.createElement("span",{className:"label-name",style:{color:"mutable"===N[e].type?"#262626":"gray"}},"实例：",n.instance&&n.instance.id?n.instance.id:"","  ",n.instance&&n.instance.name?n.instance.name:"")))})),N[e].location?c.createElement("div",{className:"app-item-versions"},c.createElement("div",{className:"app-label"},c.createElement("span",{className:"label-icon version-icon",onClick:function(){j("location",e,"")}},c.createElement("i",{style:{color:"mutable"===N[e].type?"#54CACB":"#e0e0e0"},className:"".concat(N[e].location.selected?"iconfont icon_d-pass":"")})),c.createElement("span",{className:"label-name",style:{color:"mutable"===N[e].type?"#262626":"gray"}},"服务地址：",c.createElement("input",{"data-key":e,onChange:C,value:N[e].location.location,disabled:"immutable"===N[e].type,style:{color:"mutable"===N[e].type?"#262626":"gray"}})))):null,N[e].instances.length||N[e].location?null:c.createElement("div",{className:"app-item-versions"},c.createElement("div",{className:"app-label"},c.createElement("span",{className:"label-icon version-icon"}),c.createElement("span",{className:"label-name"},"暂无，需创建")))))}))),k).map((function(e,n){return e}))),c.createElement(l.Z,{open:p,"aria-labelledby":"config-title"},c.createElement(i.Z,{id:"config-title"},"实例配置"),c.createElement(r.Z,null,c.createElement("div",{className:"appconfig-content"},f.map((function(e,n){return"object"===e.type?c.createElement("div",{key:e.key,className:"config-item",style:{marginLeft:40*e.level+"px"}},c.createElement("div",{className:"item-input"},c.createElement("label",null,e.key,":"))):c.createElement("div",{key:e.key,className:"config-item",style:{marginLeft:40*e.level+"px"}},c.createElement("div",{className:"item-input"},c.createElement("label",null,e.required?c.createElement("span",null,"* "):null,e.key,":"),c.createElement("input",{type:"number"==e.type?"number":"text",className:e.error?"red-border":"",placeholder:"number"===e.type?"请输入number类型":"请输入string类型","data-index":n,onChange:w,value:e.val})),e.error?c.createElement("p",{className:"item-error"},e.error):null)})))),c.createElement(s.Z,null,c.createElement(o.Z,{className:"common-btn",color:"primary",onClick:function(){var e=!0,n=f.slice();if(n.forEach((function(n){"object"!==n.type&&n.required&&""==n.val.trim()&&(n.error="请输入",e=!1)})),e){var t=Object.assign({},g);!function e(n,t){if(n)if("object"==n.type&&n.properties)Object.keys(n.properties).forEach((function(t){e(n.properties[t],t)}));else{console.log(222);var a=f.findIndex((function(e){return e.key===t}));n.val="number"===f[a].type?Number(f[a].val):f[a].val}}(t.userconfigs,"userconfigs"),console.log("--newAppInfo--",t),E(t),d(!1)}else v(n)}},"确定")))),c.createElement(s.Z,null,c.createElement(o.Z,{className:"common-btn",onClick:S},"取消"),c.createElement(o.Z,{className:"common-btn",color:"primary",onClick:function(){var n,t,a,c;e.submit((n=function(e){var n,t=[];return n=e,Object.keys(n).length&&Object.keys(n).forEach((function(e){var a=!1;n[e].location.selected?a=!0:n[e].instances.forEach((function(e){e.selected&&(a=!0)})),a||t.push(e)})),t}(g.dependencies||{}),console.log("--getData-0",g),{appInfo:g,notHadServe:(t=g.dependencies||[],c=[],a=t,Object.keys(a).length&&Object.keys(a).forEach((function(e){a[e].instances.length||a[e].location||c.push(e)})),c||[]),allAppSelectServe:n}))}},"确定")))}},7513:(e,n,t)=>{t.r(n),t.d(n,{default:()=>f});var a=t(8390),c=t(7294),l=t(4494),i=t(282),r=t(9669),s=t.n(r),o=t(3411),p=t(5347),d=t(2225);function m(e,n){(null==n||n>e.length)&&(n=e.length);for(var t=0,a=new Array(n);t<n;t++)a[t]=e[t];return a}var u=['name: example\ntype: webservice\nvendor: webservice\nproperties:\n    image: nginx:1.21\ntraits:\n    - type: ingress\n      properties:\n          k1: "v1"'];const f=(0,l.$j)((function(e){return e}))((function(e){var n=(0,c.useRef)(null),t=(0,c.useState)('apiVersion: aam.globalsphare.com/v1alpha1\nkind: Application\nmetadata:\n    name: example\n    version: 0.0.1\n    description: 样例应用\n    keywords:\n        - 样例应用\n    author: example@example.com\n    maintainers:\n        - email: example@example.com\n          name: example\n          web: https://example.com\n    repositories: ["https://github.com/example/example.git"]\n    bugs: https://github.com/example/example/issues\n    licenses:\n        - type: LGPL\n          url: https://license.spec.com'),l=(0,a.Z)(t,2),r=l[0],f=l[1],v=(0,c.useState)('"$schema": http://json-schema.org/draft-07/schema#\n"$id": http://example.com/product.schema.json\ntitle: User\ndescription: init user description\ntype: object\nproperties:\n    username:\n        type: string\n    password:\n        type: string\nrequired:\n    - username\n    - password'),y=(0,a.Z)(v,2),h=y[0],g=y[1],E=(0,c.useState)(u),b=(0,a.Z)(E,2),N=b[0],k=b[1],Z=(0,c.useState)('- name: gitlab\n  version: ">=0.0.1"\n  location: user-defined(https://gitlab.com)\n  items:\n      /*:\n          - create\n          - read\n          - update\n          - delete'),x=(0,a.Z)(Z,2),S=x[0],j=x[1],C=(0,c.useState)("/user:\n    - create\n    - read\n    - update\n    - delete\n/admin:\n    - create\n    - read\n    - update\n    - delete"),w=(0,a.Z)(C,2),O=w[0],A=w[1],T=(0,c.useState)(!1),q=(0,a.Z)(T,2),I=q[0],_=q[1],L=(0,c.useState)({}),H=(0,a.Z)(L,2),P=H[0],$=H[1],B=(0,c.useState)(""),D=(0,a.Z)(B,2),U=D[0],G=D[1],M=function(e){var n=e.currentTarget.dataset.index,t=N.slice();t[n]=e.target.value,k(t)},R=function(e){var n=e.currentTarget.dataset.index,t=N.slice();t.splice(n,1),k(t)};function V(){var e=/\n/g;console.log();var t=r+"\nspec:\n    userconfigs:\n        "+h.replace(e,"\n        ")+"\n    workloads:\n        "+N.map((function(n){return"- "+n.replace(e,"\n          ")})).join("\n        ")+"\n    dependencies:\n        "+S.replace(e,"\n        ")+"\n    exports:\n        "+O.replace(e,"\n        ");G(t),n.current.innerText=t}function z(){var e=document.querySelector(".createapp-left").offsetHeight;document.querySelector(".preview-pre").style.height=e-50+"px"}(0,c.useEffect)((function(){V(),z()}),[r,h,N,S,O]),(0,c.useEffect)((function(){V(),z()}),[]);var F=function(){if(""===r.trim())return o.Z.dispatch({type:p.Sn,val:"metadata不能为空"}),!1;if(1===N.length&&""===N[0].trim())return o.Z.dispatch({type:p.Sn,val:"workloads不能为空"}),!1;if(N.length>1){var e,n=!0,t=function(e,n){var t="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!t){if(Array.isArray(e)||(t=function(e,n){if(e){if("string"==typeof e)return m(e,n);var t=Object.prototype.toString.call(e).slice(8,-1);return"Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?m(e,n):void 0}}(e))||n&&e&&"number"==typeof e.length){t&&(e=t);var a=0,c=function(){};return{s:c,n:function(){return a>=e.length?{done:!0}:{done:!1,value:e[a++]}},e:function(e){throw e},f:c}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var l,i=!0,r=!1;return{s:function(){t=t.call(e)},n:function(){var e=t.next();return i=e.done,e},e:function(e){r=!0,l=e},f:function(){try{i||null==t.return||t.return()}finally{if(r)throw l}}}}(N);try{for(t.s();!(e=t.n()).done;)if(""!==e.value.trim()){n=!1;break}}catch(e){t.e(e)}finally{t.f()}return n&&o.Z.dispatch({type:p.Sn,val:"workloads不能为空"}),!n}return!0},J=function(){_(!1)};return c.createElement("section",{className:"page-container online-container"},c.createElement("div",{className:"page-title"},"创建应用"),c.createElement("section",{className:"createapp-content"},c.createElement("div",{className:"createapp-left"},c.createElement("div",{className:"online-title"},c.createElement("p",null,"metadata",c.createElement("span",null,"*"))),c.createElement("div",{className:"online-textarea"},c.createElement("textarea",{className:"textarea-input",value:r,onChange:function(e){f(e.target.value)}})),c.createElement("div",{className:"online-title"},c.createElement("p",null,"userconfigs")),c.createElement("div",{className:"online-textarea"},c.createElement("textarea",{className:"textarea-input",value:h,onChange:function(e){g(e.target.value)}})),c.createElement("div",{className:"online-title"},c.createElement("p",null,"workloads",c.createElement("span",null,"*"))),N&&N.length?N.map((function(e,n){return c.createElement("div",{className:"online-textarea vartextarea",key:n},c.createElement("textarea",{className:"textarea-input",value:e,"data-index":n,onChange:M}),N.length>1?c.createElement(i.Z,{className:"createapp-removebtn",variant:"contained",color:"secondary","data-index":n,onClick:R},"移除"):null)})):null,c.createElement("div",{className:"createapp-addbtn"},c.createElement(i.Z,{className:"online-btn",variant:"contained",color:"primary",onClick:function(){var e=N.slice();e.push(u[0]),k(e)}},"添加")),c.createElement("div",{className:"online-title"},c.createElement("p",null,"dependencies")),c.createElement("div",{className:"online-textarea"},c.createElement("textarea",{className:"textarea-input",value:S,onChange:function(e){j(e.target.value)}})),c.createElement("div",{className:"online-title"},c.createElement("p",null,"exports")),c.createElement("div",{className:"online-textarea"},c.createElement("textarea",{className:"textarea-input",value:O,onChange:function(e){A(e.target.value)}}))),c.createElement("div",{className:"createapp-right"},c.createElement("div",{className:"online-title"},c.createElement("p",null,"预览")),c.createElement("div",{className:"createapp-preview"},c.createElement("pre",{className:"preview-pre",ref:n})))),c.createElement("section",{className:"online-btns"},c.createElement(i.Z,{className:"online-btn",variant:"contained",color:"primary",onClick:function(){F()&&(o.Z.dispatch({type:p.br,val:!0}),s()({method:"POST",url:"/api/online/download",data:{yaml:U},headers:{"Content-Type":"application/json"}}).then((function(e){0==e.data.code?window.open(window.location.origin+e.data.result):o.Z.dispatch({type:p.Sn,val:e.data.result})})).catch((function(e){console.log(e),o.Z.dispatch({type:p.Sn,val:"请求错误"})})).finally((function(){o.Z.dispatch({type:p.br,val:!1})})))}},"下载"),c.createElement(i.Z,{className:"online-btn",variant:"contained",color:"primary",onClick:function(){F()&&(o.Z.dispatch({type:p.br,val:!0}),s()({method:"POST",url:"/api/online/arrange",data:{yaml:U},headers:{"Content-Type":"application/json"}}).then((function(e){0==e.data.code?(_(!0),$(e.data.result),o.Z.dispatch({type:p.Sn,val:"添加应用成功"})):o.Z.dispatch({type:p.Sn,val:e.data.result})})).catch((function(e){console.log(e),o.Z.dispatch({type:p.Sn,val:"请求错误"})})).finally((function(){o.Z.dispatch({type:p.br,val:!1})})))}},"部署")),c.createElement(d.Z,{open:I,title:"配置实例",data:P,close:J,submit:function(e){if(e.notHadServe.length)o.Z.dispatch({type:p.Sn,val:e.notHadServe.join("、")+"以上应用中不存在服务，请创建"});else if(e.allAppSelectServe.length)o.Z.dispatch({type:p.Sn,val:e.allAppSelectServe.join("、")+"以上应用未选择服务，请选择"});else{o.Z.dispatch({type:p.br,val:!0});var n=function(e){var n=[],t={};return e&&e.dependencies&&Object.keys(e.dependencies).forEach((function(t){e.dependencies[t].location.selected?n.push({name:t,location:e.dependencies[t].location.location}):e.dependencies[t].instances.forEach((function(e){e.selected&&n.push({name:e.instance.name,id:e.instance.id})}))})),e.userconfigs&&function e(n,t,a){n&&("object"==n.type&&n.properties?(a[t]={},Object.keys(n.properties).forEach((function(c){e(n.properties[c],c,a[t])}))):a[t]=n.val)}(e.userconfigs,"userconfigs",t),{id:e.id,dependencies:n,userconfigs:t.userconfigs||null}}(e.appInfo);n.status=1,console.log("selectData===",n),s()({method:"POST",url:"/api/app/run",headers:{"Content-Type":"application/json"},data:n}).then((function(e){console.log("res==",e),0===e.data.code&&(o.Z.dispatch({type:p.Sn,val:"部署完成"}),J()),o.Z.dispatch({type:p.Sn,val:e.data.result||""}),o.Z.dispatch({type:p.br,val:!1})})).catch((function(e){o.Z.dispatch({type:p.Sn,val:"请求错误"}),o.Z.dispatch({type:p.br,val:!1})}))}}}))}))}}]);